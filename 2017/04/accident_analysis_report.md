# Accident Analysis Report

在近两周，reactivesw系统出现了三次不能正常访问的情况，分别是：

* 20170415 01:57 资金不足导致系统停机
* 20170418 02:10 customer web部署出错导致无法访问
* 20170419 11:02 cluster资源不足导致服务大量重启

## 1. 20170415资金不足事故

* 发生时间: 北京时间20170415 01:57
* 处理时间: 北京时间20170415 08:22至北京时间20170415 10:01
* 直接原因: google帐号送的300美金用完，gke需要升级才能继续使用
* 根本原因: 没有彻底搞清楚gke收费标准导致费用开销过大
* 如何避免:
  1. 彻底搞清楚gke的收费标准，对每个月的收费都要有相关的记录以及分析，做好预算
  2. 事故发生之后6.5小时，运维人员才开始处理该事故，应该在第一时间通知运维人员处理
  3. 处理时间过长，运维人员应该准备好相关的部署脚步，能在半小时内重启系统
  4. 系统重启之后，需要重新导入数据，需要增加数据备份功能

## 2. 20170418部署出错

* 发生时间: 北京时间20170418 02:10
* 处理时间: 北京时间20170418 08:56至北京时间20170418 09:05
* 直接原因: customer-web服务的部署脚步出错，删除了不属于该工作区间的service，导致不能访问
* 根本原因:
  1. 开发人员对部署脚步不熟悉
  2. review人员未能发现脚步错误
  3. 缺少服务失效的告警功能
* 如何避免:
  1. 所有开发人员都需要熟悉部署流程，包括travis自动部署以及手动部署
  2. 事故发生之后6.5小时，运维人员才开始处理该事故，应该在第一时间通知运维人员处理
  3. 修改开发流程，避免开发过程影响运行版本(具体参考开发流程文档)
  4. 增加服务健康监控与告警功能

## 3. 20170419资源不足

* 发生时间: 北京时间20170419 11:02
* 处理时间: 北京时间20170419 11:02至北京时间20170419 11:35
* 直接原因: cluster资源不足，导致服务大面积重启，服务无法正常访问
* 根本原因:
  1. 启用了三套环境(default, staging, dev)导致资源耗尽
* 如何避免:
  1. 目前的资源无法支持三套环境，需要扩充cluster资源
  2. 增加自动扩容功能
  3. 增加系统资源监控功能
  4. 增加服务失效告警功能
  5. 减少微服务资源开销(目前有两个方向: springboot框架资源控制，Schedule资源控制)
  6. 增加数据备份功能

## 4. 总结
1. 开发人员对部署流程没有掌握好，流程也没有稳定的规范，本周（2017/04/24）完善部署流程说明文档，后期严格按照文档进行操作。同时为了让开发人员均熟悉部署流程，每个人负责的服务由该同事负责dev环境的部署与更新。
2. 之前一直以dev环境为主进行开发，现在正式加入staging环境，需要完善正式的发布流程与方式，例如需要增加：服务健康检查与告警，k8s系统检查与告警，数据定期备份等。
3. 制定详细的云计算资源使用计划，并做月度报告。
